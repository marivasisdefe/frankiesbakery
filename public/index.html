<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="img/apple-touch-icon.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="img/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="img/apple-touch-icon-114x114.png" />

  <link rel="stylesheet" type="text/css" href="css/bootstrap.css" />
  <link rel="stylesheet" type="text/css" href="fonts/font-awesome/css/font-awesome.css" />
  <link rel="stylesheet" type="text/css" href="css/nivo-lightbox/nivo-lightbox.css" />
  <link rel="stylesheet" type="text/css" href="css/nivo-lightbox/default.css" />
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Raleway:300,400,500,600,700,800,900" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" href="css/style.css" />

  <title>Isdefe - BoletinIA</title>
  <meta name="description" content="Piloto generaci√≥n Bolet√≠n informativo mediante herramientas IA fecha: 09/09/2025 11:58" />
  <meta name="author" content="Isdefe" />

  <style>
    .admin-panel {
      display: flex;
      align-items: center;
    }
    .admin-panel img {
      max-width: 50%;
      height: auto;
    }
    .admin-panel-content {
      padding-left: 20px;
      max-width: 50%;
    }
    .chat-panel {
      display: flex;
      align-items: center;
      margin-top: 20px;
    }
    .chat-panel img {
      max-width: 50%;
      height: auto;
    }
    .chat-panel-content {
      padding-left: 20px;
      max-width: 50%;
    }
  </style>
</head>

<body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top">
  <div id="root"></div>
  <script type="text/javascript" src="js/jquery.1.11.1.js"></script>
  <script type="text/javascript" src="js/bootstrap.js"></script>

  <!-- Panel de administraci√≥n -->
  <div class="container admin-panel">
    <img src="img/pexels-igor-ovsyannykov-56123-205961.jpg"  alt="Admin Panel Image">
    <div class="admin-panel-content">
      <h2>Admin Panel</h2>
      <div id="upload-section">
        <h3>Upload Files</h3>
          <div>
            <input type="file" name="file" id="fileInput" required>
          </div>
          <div>
            <button onclick="uploadToAzure()">Subir fichero</button>
          </div>
      </div>
      <hr>
      <div id="process-section">
        <h3>Process Files</h3>
        <button onclick="processFiles()">Procesar contenido</button>
        <div id="spinner" style="display: none;">
          <img src="img/spinner.gif" alt="Loading..." />
        </div>
        <div id="process-status"></div>
      </div>
    </div>
  </div>

  <!-- Chat con Azure -->
<div class="container chat-panel">
  <img src="img/robot.jpg" alt="Chat with Azure Image">
  <div class="chat-panel-content">
    <h2>Pregunta a Boletines</h2>
    <div id="chatbox" class="chatbox">
      <div class="bot-message">
        <strong>Bot:</strong> üëã Hola, soy tu asistente de <b>Boletines</b>.<br><br>
        üìå <b>C√≥mo funciono:</b><br>
        - Genero <b>boletines informativos</b> en secciones fijas (con emojis y listas).<br>
        - Solo uso la informaci√≥n disponible en <code>contexts</code>.<br>
        - Para obtener una secci√≥n, debes <b>preguntar con su nombre exacto</b>.<br><br>
        ‚ú® <b>Secciones disponibles:</b><br>
        - üì∞ TITULAR<br>
        - üìå RESUMEN EJECUTIVO<br>
        - üç© RECUENTO DE PROYECTOS<br>
        - üìå INFORMACI√ìN GENERAL<br>
        - ‚úÖ PROBLEMAS SOLUCIONADOS<br>
        - ‚ùó PROBLEMAS ABIERTOS<br>
        - üöÄ SUBIDAS PROGRAMADAS<br>
        - üìÖ FECHAS CLAVE<br>
        - üÜï LANZAMIENTOS Y ARRANQUES<br>
        - üß± ARQUITECTURA<br>
        - üóÇÔ∏è METADATOS<br>
        - üîö CONCLUSI√ìN<br>
      </div>
    </div>
    <div class="input-area">
      <input type="text" id="userInput" placeholder="Escribe tu mensaje aqu√≠..." />
      <button id="sendBtn" onclick="sendMessage()">Enviar</button>
    </div>
  </div>
</div>

<style>
  .chatbox {
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 10px;
    height: 350px;
    overflow-y: auto;
    background-color: #fafafa;
    margin-bottom: 10px;
    font-family: 'Segoe UI Emoji', 'Noto Color Emoji', 'Apple Color Emoji', sans-serif;
  }
  .user-message, .bot-message {
    margin: 8px 0;
    padding: 10px;
    border-radius: 12px;
    max-width: 80%;
    clear: both;
    white-space: pre-wrap;
  }
  .user-message {
    background-color: #d1ecf1;
    float: right;
    text-align: right;
  }
  .bot-message {
    background-color: #f8d7da;
    float: left;
    text-align: left;
  }
  .typing {
    font-style: italic;
    color: #777;
    margin: 5px 0;
  }
  .input-area {
    display: flex;
    gap: 5px;
  }
  #userInput {
    flex: 1;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }
  #sendBtn {
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    background-color: #007bff;
    color: white;
    cursor: pointer;
  }
  #sendBtn:disabled {
    background-color: #aaa;
    cursor: not-allowed;
  }

  /* Estilo de secciones y listas en la respuesta del bot */
  .bot-message h3 {
    margin: 10px 0 5px;
    color: #b22222; /* color rojo para t√≠tulos */
  }
  .bot-message ul {
    margin: 5px 0 10px 20px;
    padding: 0;
  }
  .bot-message li {
    margin-bottom: 5px;
  }
</style>

<script>
  // Funci√≥n para transformar el texto plano del bolet√≠n en HTML
  function formatBotResponse(text) {
    let html = text;

    // Convertir t√≠tulos de secci√≥n === TEXTO === en h3
    html = html.replace(/===\s*(.*?)\s*===/g, '<h3>üìå $1</h3>');

    // Detectar l√≠neas que empiezan con "-" o "√Årea X:" y envolverlas en <li>
    html = html.replace(/^(?:- |√Årea \d+: )(.*)$/gm, '<li>$1</li>');

    // Agrupar consecutivos <li> en <ul>
    html = html.replace(/(<li>.*<\/li>(\n)?)+/gs, match => `<ul>${match.replace(/\n/g,'')}</ul>`);

    // Mantener saltos de l√≠nea fuera de listas
    html = html.replace(/\n/g, "<br>");

    return html;
  }

  async function uploadToAzure() {
    const fileInput = document.getElementById('fileInput');
    if (fileInput.files.length === 0) return alert('Selecciona un archivo.');

    const file = fileInput.files[0];

    // 1. Obtener la URL SAS del backend
    const resp = await fetch(`/api/getsasurl?filename=${encodeURIComponent(file.name)}`);
    const data = await resp.json();
    if (!data.uploadUrl) return alert('No se pudo obtener la URL de subida');

    // 2. Subir el archivo a Azure Blob Storage usando la URL SAS
    const putResp = await fetch(data.uploadUrl, {
      method: 'PUT',
      headers: {
        'x-ms-blob-type': 'BlockBlob',
        'Content-Type': file.type
      },
      body: file
    });
    if (putResp.ok) {
      alert('Archivo subido correctamente');
    } else {
      alert('Error al subir el archivo');
    }
  }

  async function sendMessage() {
    const input = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatbox = document.getElementById("chatbox");
    const userInput = input.value.trim();

    if (!userInput) return;

    // Mostrar mensaje del usuario
    chatbox.innerHTML += `<div class="user-message"><strong>T√∫:</strong> ${userInput}</div>`;
    input.value = "";
    chatbox.scrollTop = chatbox.scrollHeight;

    // Desactivar bot√≥n y mostrar "Bot escribiendo..."
    sendBtn.disabled = true;
    const typingMsg = document.createElement("div");
    typingMsg.className = "typing";
    typingMsg.id = "typing";
    typingMsg.innerText = "Bot est√° escribiendo...";
    chatbox.appendChild(typingMsg);
    chatbox.scrollTop = chatbox.scrollHeight;

    try {
      const response = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: userInput })
      });

      if (!response.ok) throw new Error("Error HTTP " + response.status);

      const data = await response.json();

      // Eliminar "Bot escribiendo..."
      document.getElementById("typing")?.remove();

      // Mostrar respuesta del bot formateada
      chatbox.innerHTML += `<div class="bot-message"><strong>Bot:</strong><br>${formatBotResponse(data.response)}</div>`;
    } catch (error) {
      console.error(error);
      document.getElementById("typing")?.remove();
      chatbox.innerHTML += `<div class="bot-message"><strong>Bot:</strong> ‚ùå Error al conectar con el servidor.</div>`;
    } finally {
      sendBtn.disabled = false;
      chatbox.scrollTop = chatbox.scrollHeight;
    }
  }

  // Enviar con Enter
  document.getElementById("userInput").addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
      event.preventDefault();
      sendMessage();
    }
  });
</script>


<!-- Bloque Generar Bolet√≠n -->
<div class="container chat-panel" style="margin-top: 40px;">
  <img src="img/boletin.jpg" alt="Generar Bolet√≠n Image">
  <div class="chat-panel-content">
    <h2>Generar Bolet√≠n</h2>
    <p>Descarga un bolet√≠n en Word con todas las respuestas del chat.</p>
    <button onclick="generateBoletin()">Descargar Bolet√≠n</button>
  </div>
</div>

<script>
  async function generateBoletin() {
    const chatbox = document.getElementById("chatbox");
    const botMessages = chatbox.querySelectorAll(".bot-message");

    if (botMessages.length === 0) {
      alert("No hay contenido del bot para generar el bolet√≠n.");
      return;
    }

    // Concatenar todas las respuestas del bot
    let chatContent = "";
    botMessages.forEach(msg => {
      let text = msg.innerText.replace("Bot:", "").trim();
      chatContent += text + "\n\n";
    });

    try {
      const response = await fetch("/api/generateword", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: "Bolet√≠n de Conversaci√≥n",
          author: "Usuario",
          content: chatContent
        })
      });

      if (!response.ok) throw new Error("Error HTTP " + response.status);

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "boletin.docx";
      document.body.appendChild(a);
      a.click();
      a.remove();

    } catch (error) {
      console.error(error);
      alert("Error al generar el bolet√≠n.");
    }
  }
</script>

<!-- Bloque Chat 2 independiente -->
<div class="container chat-panel" style="margin-top: 40px;">
  <img src="img/chat_boletin.jpg" alt="Chat con Azure2 Image">
  <div class="chat-panel-content">
    <h2>Pregunta a Boletines (Azure2)</h2>
    <div id="chatbox2" class="chatbox">
      <div class="bot-message">
        <strong>Bot:</strong> üëã Hola, soy tu asistente <b>Boletines Azure2</b>.<br><br>
        üìå <b>C√≥mo funciono:</b><br>
        - Respondo bas√°ndome en los <b>or√≠genes de datos</b> disponibles.<br>
        - Siempre sigo el orden de prioridad establecido.<br>
        - Para obtener informaci√≥n, indica el <b>nombre exacto</b> del origen.<br><br>
        ‚ú® <b>Or√≠genes de datos disponibles:</b><br>
        1Ô∏è‚É£ üìÑ Documentos internos ‚Äî prioridad alta.<br>
        2Ô∏è‚É£ üß† Conocimiento general del modelo ‚Äî solo si no hay documentos.<br>
        3Ô∏è‚É£ üåê Fuentes externas v√≠a internet ‚Äî √∫nicamente de organismos oficiales.<br>
      </div>
    </div>
    <div class="input-area">
      <input type="text" id="userInput2" placeholder="Escribe tu mensaje aqu√≠..." />
      <button id="sendBtn2" onclick="sendMessage2()">Enviar</button>
    </div>
  </div>
</div>

<style>
  /* Estilos independientes para el segundo chat */
  #userInput2 {
    flex: 1;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }
  #sendBtn2 {
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    background-color: #007bff;
    color: white;
    cursor: pointer;
  }
  #sendBtn2:disabled {
    background-color: #aaa;
    cursor: not-allowed;
  }
</style>

<script>
  // Funci√≥n independiente para el chat 2
  async function sendMessage2() {
    const input = document.getElementById("userInput2");
    const sendBtn = document.getElementById("sendBtn2");
    const chatbox = document.getElementById("chatbox2");
    const userInput = input.value.trim();
    if (!userInput) return;

    chatbox.innerHTML += `<div class="user-message"><strong>T√∫:</strong> ${userInput}</div>`;
    input.value = "";
    chatbox.scrollTop = chatbox.scrollHeight;

    sendBtn.disabled = true;
    const typingMsg = document.createElement("div");
    typingMsg.className = "typing";
    typingMsg.id = "typing2";
    typingMsg.innerText = "Bot est√° escribiendo...";
    chatbox.appendChild(typingMsg);
    chatbox.scrollTop = chatbox.scrollHeight;

    try {
      const response = await fetch("/api/chat2", { // Endpoint independiente
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: userInput })
      });

      if (!response.ok) throw new Error("Error HTTP " + response.status);

      const data = await response.json();
      document.getElementById("typing2")?.remove();
      chatbox.innerHTML += `<div class="bot-message"><strong>Bot:</strong><br>${data.response}</div>`;
    } catch (error) {
      console.error(error);
      document.getElementById("typing2")?.remove();
      chatbox.innerHTML += `<div class="bot-message"><strong>Bot:</strong> ‚ùå Error al conectar con el servidor.</div>`;
    } finally {
      sendBtn.disabled = false;
      chatbox.scrollTop = chatbox.scrollHeight;
    }
  }

  // Enviar con Enter
  document.getElementById("userInput2").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
      event.preventDefault();
      sendMessage2();
    }
  });
</script>

</body>
</html>
