<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="img/apple-touch-icon.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="img/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="img/apple-touch-icon-114x114.png" />

  <link rel="stylesheet" type="text/css" href="css/bootstrap.css" />
  <link rel="stylesheet" type="text/css" href="fonts/font-awesome/css/font-awesome.css" />
  <link rel="stylesheet" type="text/css" href="css/nivo-lightbox/nivo-lightbox.css" />
  <link rel="stylesheet" type="text/css" href="css/nivo-lightbox/default.css" />
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Raleway:300,400,500,600,700,800,900" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" href="css/style.css" />

  <title>Isdefe - BoletinIA</title>
  <meta name="description" content="Piloto generaci√≥n Bolet√≠n informativo mediante herramientas IA fecha: 09/09/2025 11:58" />
  <meta name="author" content="Isdefe" />

  <style>
    .admin-panel {
      display: flex;
      align-items: center;
    }
    .admin-panel img {
      max-width: 50%;
      height: auto;
    }
    .admin-panel-content {
      padding-left: 20px;
      max-width: 50%;
    }
    .chat-panel {
      display: flex;
      align-items: center;
      margin-top: 20px;
    }
    .chat-panel img {
      max-width: 50%;
      height: auto;
    }
    .chat-panel-content {
      padding-left: 20px;
      max-width: 50%;
    }
  </style>
</head>

<body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top">
  <div id="root"></div>
  <script type="text/javascript" src="js/jquery.1.11.1.js"></script>
  <script type="text/javascript" src="js/bootstrap.js"></script>

  <!-- Panel de administraci√≥n -->
  <div class="container admin-panel">
    <img src="img/pexels-igor-ovsyannykov-56123-205961.jpg"  alt="Admin Panel Image">
    <div class="admin-panel-content">
      <h2>Admin Panel</h2>
      <div id="upload-section">
        <h3>Upload Files</h3>
        <form action="/upload" method="post" enctype="multipart/form-data">
          <div>
            <input type="file" name="file" required>
          </div>
          <div>
            <button type="submit">Upload File</button>
          </div>
        </form>
      </div>
      <hr>
      <div id="process-section">
        <h3>Process Files</h3>
        <button onclick="processFiles()">Process Files</button>
        <div id="spinner" style="display: none;">
          <img src="img/spinner.gif" alt="Loading..." />
        </div>
        <div id="process-status"></div>
      </div>
    </div>
  </div>

    <!-- Chat con Azure -->
  <div class="container chat-panel">
    <img src="img/robot.jpg" alt="Chat with Azure Image">
    <div class="chat-panel-content">
      <h2>Pregunta a Boletines</h2>
      <div id="chatbox" class="chatbox">
        <div class="bot-message">
          <strong>Bot:</strong> üëã Hola, soy tu asistente de <b>Boletines</b>.<br><br>
          üìå <b>C√≥mo funciono:</b><br>
          - Genero <b>boletines informativos</b> en secciones fijas (con emojis y listas).<br>
          - Solo uso la informaci√≥n disponible en <code>contexts</code>.<br>
          - Para obtener una secci√≥n, debes <b>preguntar con su nombre exacto</b>.<br><br>
          ‚ú® <b>Ejemplos:</b><br>
          - "Genera un bolet√≠n completo"<br>
          - "Dame la secci√≥n Problemas abiertos"<br>
          - "Mu√©strame Resumen Ejecutivo"<br>
          - "Quiero solo Fechas clave"<br>
        </div>
      </div>
      <div class="input-area">
        <input type="text" id="userInput" placeholder="Escribe tu mensaje aqu√≠..." />
        <button id="sendBtn" onclick="sendMessage()">Enviar</button>
      </div>
    </div>
  </div>

  <style>
    .chatbox {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      background-color: #fafafa;
      margin-bottom: 10px;
      font-family: 'Segoe UI Emoji', 'Noto Color Emoji', 'Apple Color Emoji', sans-serif;
    }
    .user-message, .bot-message {
      margin: 8px 0;
      padding: 10px;
      border-radius: 12px;
      max-width: 80%;
      clear: both;
      white-space: pre-wrap;
    }
    .user-message {
      background-color: #d1ecf1;
      float: right;
      text-align: right;
    }
    .bot-message {
      background-color: #f8d7da;
      float: left;
      text-align: left;
    }
    .typing {
      font-style: italic;
      color: #777;
      margin: 5px 0;
    }
    .input-area {
      display: flex;
      gap: 5px;
    }
    #userInput {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #sendBtn {
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    #sendBtn:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
  </style>

  <script>
    async function sendMessage() {
      const input = document.getElementById("userInput");
      const sendBtn = document.getElementById("sendBtn");
      const chatbox = document.getElementById("chatbox");
      const userInput = input.value.trim();

      if (!userInput) return;

      // Mostrar mensaje del usuario
      chatbox.innerHTML += `<div class="user-message"><strong>T√∫:</strong> ${userInput}</div>`;
      input.value = "";
      chatbox.scrollTop = chatbox.scrollHeight;

      // Desactivar bot√≥n y mostrar "Bot escribiendo..."
      sendBtn.disabled = true;
      const typingMsg = document.createElement("div");
      typingMsg.className = "typing";
      typingMsg.id = "typing";
      typingMsg.innerText = "Bot est√° escribiendo...";
      chatbox.appendChild(typingMsg);
      chatbox.scrollTop = chatbox.scrollHeight;

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: userInput })
        });

        if (!response.ok) throw new Error("Error HTTP " + response.status);

        const data = await response.json();

        // Eliminar "Bot escribiendo..."
        document.getElementById("typing")?.remove();

        // Mostrar respuesta del bot con emojis y formato
        chatbox.innerHTML += `<div class="bot-message"><strong>Bot:</strong> ${data.response}</div>`;
      } catch (error) {
        console.error(error);
        document.getElementById("typing")?.remove();
        chatbox.innerHTML += `<div class="bot-message"><strong>Bot:</strong> ‚ùå Error al conectar con el servidor.</div>`;
      } finally {
        sendBtn.disabled = false;
        chatbox.scrollTop = chatbox.scrollHeight;
      }
    }

    // Enviar con Enter
    document.getElementById("userInput").addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        event.preventDefault();
        sendMessage();
      }
    });
  </script>

  <!-- Bloque Generar Bolet√≠n -->
<div class="container chat-panel" style="margin-top: 40px;">
  <img src="img/boletin.jpg" alt="Generar Bolet√≠n Image">
  <div class="chat-panel-content">
    <h2>Generar Bolet√≠n</h2>
    <p>Descarga un bolet√≠n en Word con la √∫ltima conversaci√≥n del chat.</p>
    <button onclick="generateBoletin()">Descargar Bolet√≠n</button>
  </div>
</div>

<script>
  async function generateBoletin() {
    // Obtener la √∫ltima respuesta del chat
    const chatbox = document.getElementById("chatbox");
    const lastBotMessage = chatbox.querySelector(".bot-message:last-of-type");
    const chatContent = lastBotMessage ? lastBotMessage.innerText.replace("Bot: ", "") : "Bolet√≠n vac√≠o";

    try {
      const response = await fetch("/api/generateword", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: "Bolet√≠n de Conversaci√≥n",
          author: "Usuario",
          content: chatContent
        })
      });

      if (!response.ok) throw new Error("Error HTTP " + response.status);

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "boletin.docx";
      document.body.appendChild(a);
      a.click();
      a.remove();

    } catch (error) {
      console.error(error);
      alert("Error al generar el bolet√≠n.");
    }
  }
</script>
</body>
</html>
